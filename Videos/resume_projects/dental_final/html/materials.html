<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Materials Form</title>
  <style>
    /* Your existing CSS remains unchanged */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(to right, #a7cad5, #5dafd2);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
    }

    .navbar {
      background: linear-gradient(90deg, #b6e2e2 0%, #eaf6f6 100%);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }

    .navbar ul {
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 24px;
      height: 60px;
      margin: 0;
    }

    .navbar li {
      margin: 0 12px;
    }

    .navbar .nav-link {
      padding: 12px 20px;
      color: #1e7fa7;
      text-decoration: none;
      font-weight: 500;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .navbar .nav-link.active,
    .navbar .nav-link:hover {
      background: #1e7fa7;
      color: #fff;
    }

    .content-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 80px 20px;
      min-height: 100vh;
    }

    .search-container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 2px solid #333;
      width: 100%;
      max-width: 600px;
      margin-bottom: 24px;
    }

    .search-container label {
      display: block;
      color: #04113e;
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .search-container input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #0b76d3;
      border-radius: 5px;
      font-size: 14px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .search-container input[type="text"]:focus {
      outline: none;
      border-color: #080707;
      box-shadow: 0 0 5px rgba(6, 84, 117, 0.5);
    }

    #searchResults {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: #f9f9f9;
      font-size: 14px;
      display: none;
      min-height: 40px;
    }

    .invoice-form {
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 2px solid #333;
      width: 100%;
      max-width: 600px;
    }

    .invoice-form h1 {
      color: #091254;
      font-size: 20px;
      margin-bottom: 20px;
      text-align: center;
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .form-row label {
      color: #04113e;
      font-weight: 500;
      font-size: 14px;
    }

    .form-row input,
    .form-row textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #0b76d3;
      border-radius: 5px;
      font-size: 14px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .form-row input:focus,
    .form-row textarea:focus {
      outline: none;
      border-color: #080707;
      box-shadow: 0 0 5px rgba(6, 84, 117, 0.5);
    }

    .form-row textarea {
      resize: vertical;
      min-height: 80px;
    }

    input[type="submit"] {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 5px;
      background-color: #08277b;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    input[type="submit"]:hover {
      background-color: #0b3aa0;
    }

    @media (max-width: 600px) {
      .invoice-form, .search-container {
        max-width: 90%;
        padding: 16px;
      }

      .form-row {
        gap: 6px;
        margin-bottom: 12px;
      }

      input[type="submit"] {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <ul>
      <li><a href="patients.html" class="nav-link" id="nav-patients">Patients</a></li>
      <li><a href="home.html" class="nav-link" id="nav-home">Home</a></li>
      <li><a href="materials.html" class="nav-link active" id="nav-materials">Materials</a></li>
      <li><a href="note.html" class="nav-link" id="nav-note">Note</a></li>
      <li><a href="card.html" class="nav-link" id="nav-card">Card</a></li>
      <li><a href="salary.html" class="nav-link" id="nav-salary">Salary</a></li>
      <li><a href="register.html" class="nav-link" id="nav-register">Register</a></li>
      <li><a href="invoice.html" class="nav-link" id="nav-invoice">Invoice</a></li>
      <li><a href="exp.html" class="nav-link" id="nav-exp">Expenses</a></li>
      <li><a href="challan.html" class="nav-link" id="nav-challan">Delivery Challan</a></li>
    </ul>
  </nav>

  <div class="content-wrapper">
    <div class="search-container">
      <label for="searchMaterial">Search Material</label>
      <input type="text" id="searchMaterial" placeholder="Enter material name to search..." aria-label="Search material by name">
      <div id="searchResults" aria-live="polite"></div>
    </div>

    <form class="invoice-form" id="materialForm" onsubmit="handleSubmit(event)">
      <h1>Material Details</h1>
      <div class="form-row">
        <label for="name">Material Name</label>
        <input type="text" id="name" name="name" required aria-required="true">
      </div>
      <div class="form-row">
        <label for="quantity">Quantity</label>
        <input type="number" id="quantity" name="quantity" min="0" required aria-required="true">
      </div>
      <div class="form-row">
        <label for="cost">Cost</label>
        <input type="number" id="cost" name="cost" min="0" step="0.01" required aria-required="true">
      </div>
      <div class="form-row">
        <label for="dateAdded">Date Added</label>
        <input type="date" id="dateAdded" name="dateAdded" required aria-required="true">
      </div>
      <input type="submit" value="Submit" id="submitBtn">
    </form>
  </div>

  <script>
    let isEditing = false;
    let editId = null;

    // Handle form submission (add or update)
async function handleSubmit(event) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  let data = Object.fromEntries(formData);

  // Validate and sanitize data
  data = {
    name: data.name ? data.name.trim() : '',
    quantity: parseInt(data.quantity) || 0,
    cost: parseFloat(data.cost) || 0.00,
    date_added: data.dateAdded // Input type="date" ensures yyyy-MM-dd format
  };

  // Additional validation
  if (!data.name || data.quantity < 0 || data.cost < 0) {
    alert('Please provide a valid name and non-negative quantity/cost.');
    return;
  }

  // Ensure date_added is valid
  if (!data.date_added || !/^\d{4}-\d{2}-\d{2}$/.test(data.date_added)) {
    const now = new Date().toISOString().split('T')[0];
    data.date_added = now;
    form.querySelector('#dateAdded').value = now;
  }

  const baseUrl = window.getApiUrl ? window.getApiUrl('api/materials') : 'http://localhost:3000/api/materials';
  const url = isEditing ? baseUrl.replace('/api/materials', `/api/materials/${editId}`) : baseUrl;
  const method = isEditing ? 'PUT' : 'POST';

  console.log('Sending request:', { url, method, data }); // Debug log
  try {
    const response = await fetch(url, {
      method: method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    console.log('Response status:', response.status); // Debug log
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`HTTP error! status: ${response.status}, message: ${errorText.substring(0, 100)}...`);
    }

    // Check if response is JSON before parsing
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      const errorText = await response.text();
      throw new Error(`Invalid response format! Expected JSON, got: ${errorText.substring(0, 100)}...`);
    }

    const result = await response.json();
    console.log('Response data:', result); // Debug log
    alert(`${isEditing ? 'Material updated' : 'Material saved'} successfully!`);
    form.reset();
    form.querySelector('#dateAdded').value = new Date().toISOString().split('T')[0];
    document.getElementById('submitBtn').value = 'Submit';
    isEditing = false;
    editId = null;
    // Refresh search results
    document.getElementById('searchMaterial').dispatchEvent(new Event('input'));
  } catch (error) {
    console.error('Error submitting form:', error.message || error);
    alert(`An error occurred: ${error.message.includes('<!DOCTYPE') || error.message.includes('Invalid response') ? 'Server error, see console for details' : error.message}`);
  }
}
    // Handle material search and make results editable
    document.getElementById('searchMaterial').addEventListener('input', async function(e) {
      const searchTerm = e.target.value.trim();
      const searchResults = document.getElementById('searchResults');

      if (searchTerm.length > 2) {
        try {
          const apiUrl = window.getApiUrl ? window.getApiUrl(`api/materials/search?query=${encodeURIComponent(searchTerm)}`) : `http://localhost:3000/api/materials/search?query=${encodeURIComponent(searchTerm)}`;
          const response = await fetch(apiUrl, {
            method: 'GET'
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const results = await response.json();
          searchResults.style.display = 'block';

          if (results.length === 0) {
            searchResults.textContent = 'No materials found.';
          } else {
            searchResults.innerHTML = results.map(material => {
              const displayDate = material.date_added && /^\d{4}-\d{2}-\d{2}$/.test(material.date_added)
                ? material.date_added
                : new Date().toISOString().split('T')[0]; // "2025-07-02"
              const editDate = material.date_added && /^\d{4}-\d{2}-\d{2}$/.test(material.date_added)
                ? material.date_added
                : new Date().toISOString().split('T')[0]; // "2025-07-02"
              return `
                <div>
                  <strong>Name:</strong> ${material.name} |
                  <strong>Quantity:</strong> ${material.quantity} |
                  <strong>Cost:</strong> $${material.cost.toFixed(2)} |
                  <strong>Date Added:</strong> ${displayDate}
                  <button style="padding: 6px 12px; border: none; border-radius: 6px; background: linear-gradient(90deg, #4facfe, #00f2fe); color: white; font-weight: 500; cursor: pointer; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); transition: all 0.3s ease;"
                    onmouseover="this.style.background='linear-gradient(90deg, #00f2fe, #4facfe)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.3)';"
                    onmouseout="this.style.background='linear-gradient(90deg, #4facfe, #00f2fe)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(0, 0, 0, 0.2)';"
                    onclick="editMaterial(${material.id}, '${material.name}', ${material.quantity}, ${material.cost}, '${editDate}')">Edit</button>
                </div>
              `;
            }).join('<hr>');
          }
        } catch (error) {
          console.error('Error searching materials:', error.message || error);
          searchResults.style.display = 'block';
          searchResults.textContent = `Error searching materials: ${error.message || 'Unknown error'}`;
        }
      } else {
        searchResults.style.display = 'none';
        searchResults.textContent = '';
      }
    });

    // Function to populate form for editing
    function editMaterial(id, name, quantity, cost, dateAdded) {
      isEditing = true;
      editId = id;
      document.getElementById('name').value = name || '';
      document.getElementById('quantity').value = quantity || 0;
      document.getElementById('cost').value = cost || 0.00;
      // Ensure dateAdded is a valid yyyy-MM-dd string
      const validDate = dateAdded && /^\d{4}-\d{2}-\d{2}$/.test(dateAdded) ? dateAdded : new Date().toISOString().split('T')[0];
      document.getElementById('dateAdded').value = validDate;
      document.getElementById('submitBtn').value = 'Update';
    }

    // Initialize navigation and date on page load
    document.addEventListener('DOMContentLoaded', function() {
      const path = window.location.pathname;
      const navLinks = {
        'materials.html': 'nav-materials',
        'note.html': 'nav-note',
        'card.html': 'nav-card',
        'salary.html': 'nav-salary',
        'register.html': 'nav-register',
        'invoice.html': 'nav-invoice',
        'exp.html': 'nav-exp',
        'challan.html': 'nav-challan' // Updated to match new ID
      };

      for (const [page, id] of Object.entries(navLinks)) {
        if (path.includes(page)) {
          document.getElementById(id)?.classList.add('active');
        }
      }

      // Set default date to current date on load
      const now = new Date().toISOString().split('T')[0]; // "2025-07-02"
      document.getElementById('dateAdded').value = now;
    });
  </script>
</body>
</html>